---
import Layout from "@/layouts/Layout.astro";

// Check if already logged in
if (Astro.locals.user) {
  if (Astro.locals.user.role === "admin") {
    return Astro.redirect("/admin/dashboard");
  }
  return Astro.redirect("/dashboard");
}

const error = Astro.url.searchParams.get("error");
const success = Astro.url.searchParams.get("success");

let errorMessage = "";
if (error === "email_exists") {
  errorMessage = "Konto z tym adresem email już istnieje.";
} else if (error === "weak_password") {
  errorMessage = "Hasło musi mieć minimum 8 znaków.";
} else if (error === "passwords_mismatch") {
  errorMessage = "Podane hasła nie są takie same.";
} else if (error === "invalid_email") {
  errorMessage = "Nieprawidłowy adres email.";
} else if (error === "missing_fields") {
  errorMessage = "Proszę wypełnić wszystkie pola.";
} else if (error === "server_error") {
  errorMessage = "Wystąpił błąd serwera. Spróbuj ponownie później.";
}

let successMessage = "";
if (success === "registered") {
  successMessage = "Konto zostało utworzone! Możesz się teraz zalogować.";
}
---

<Layout title="Rejestracja - LearnAI">
  <div class="min-h-screen flex items-center justify-center bg-slate-950 px-4">
    <div class="max-w-md w-full">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-blue-600 text-transparent bg-clip-text mb-2">
          LearnAI
        </h1>
        <p class="text-gray-400">Utwórz nowe konto</p>
      </div>

      {
        errorMessage && (
          <div class="mb-6 p-4 rounded-lg bg-red-500/10 border border-red-500/50 text-red-400 text-sm">
            {errorMessage}
          </div>
        )
      }

      {
        successMessage && (
          <div class="mb-6 p-4 rounded-lg bg-green-500/10 border border-green-500/50 text-green-400 text-sm">
            {successMessage}
          </div>
        )
      }

      <div class="bg-slate-800/50 border border-white/10 rounded-lg p-8 backdrop-blur-sm">
        <form method="POST" action="/api/auth/signup" class="space-y-4" id="register-form">
          <div>
            <label for="full_name" class="block text-sm font-medium text-gray-300 mb-2"> Imię i nazwisko </label>
            <input
              type="text"
              id="full_name"
              name="full_name"
              class="w-full px-4 py-3 rounded-lg bg-slate-700/50 border border-white/10 text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600"
              placeholder="Jan Kowalski"
            />
          </div>

          <div>
            <label for="email" class="block text-sm font-medium text-gray-300 mb-2"> Email </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 rounded-lg bg-slate-700/50 border border-white/10 text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600"
              placeholder="twoj@email.com"
            />
          </div>

          <div>
            <label for="password" class="block text-sm font-medium text-gray-300 mb-2"> Hasło </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              minlength="8"
              class="w-full px-4 py-3 rounded-lg bg-slate-700/50 border border-white/10 text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600"
              placeholder="Minimum 8 znaków"
            />
            <p class="mt-1 text-xs text-gray-500">Hasło musi zawierać minimum 8 znaków</p>
          </div>

          <div>
            <label for="confirm_password" class="block text-sm font-medium text-gray-300 mb-2"> Potwierdź hasło </label>
            <input
              type="password"
              id="confirm_password"
              name="confirm_password"
              required
              minlength="8"
              class="w-full px-4 py-3 rounded-lg bg-slate-700/50 border border-white/10 text-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600"
              placeholder="Powtórz hasło"
            />
          </div>

          <div
            id="client-error"
            class="hidden p-3 rounded-lg bg-red-500/10 border border-red-500/50 text-red-400 text-sm"
          >
          </div>

          <button
            type="submit"
            class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-all shadow-lg hover:shadow-blue-500/50 transform hover:scale-105"
          >
            Zarejestruj się
          </button>
        </form>

        <div class="mt-6 text-center text-sm text-gray-400">
          <p>
            Masz już konto? <a href="/login" class="text-blue-400 hover:text-blue-300 hover:underline">Zaloguj się</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("register-form") as HTMLFormElement;
    const clientError = document.getElementById("client-error") as HTMLDivElement;

    form.addEventListener("submit", (e) => {
      const password = (document.getElementById("password") as HTMLInputElement).value;
      const confirmPassword = (document.getElementById("confirm_password") as HTMLInputElement).value;
      const email = (document.getElementById("email") as HTMLInputElement).value;

      // Reset error
      clientError.classList.add("hidden");
      clientError.textContent = "";

      // Validate passwords match
      if (password !== confirmPassword) {
        e.preventDefault();
        clientError.textContent = "Hasła nie są takie same.";
        clientError.classList.remove("hidden");
        return;
      }

      // Validate password strength
      if (password.length < 8) {
        e.preventDefault();
        clientError.textContent = "Hasło musi mieć minimum 8 znaków.";
        clientError.classList.remove("hidden");
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        e.preventDefault();
        clientError.textContent = "Nieprawidłowy format adresu email.";
        clientError.classList.remove("hidden");
        return;
      }
    });
  </script>
</Layout>
