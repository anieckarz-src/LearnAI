---
import Layout from "@/layouts/Layout.astro";
import { LessonSidebar } from "@/components/course/LessonSidebar";
import { LessonContent } from "@/components/course/LessonContent";

const { courseId, lessonId } = Astro.params;

if (!courseId || !lessonId) {
  return Astro.redirect("/courses");
}

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

// Fetch lesson details with full course data
let lesson = null;
let course = null;
let allLessons: any[] = [];
let lessonProgress: any[] = [];
let quizzes = null;
let error: string | null = null;
let hasAccess = false;

try {
  const { supabase } = Astro.locals;

  // Fetch course with all lessons and access mode
  const { data: courseData, error: courseError } = await supabase
    .from("courses")
    .select(
      `
      *,
      lessons (
        id,
        title,
        content,
        video_url,
        order_index,
        created_at
      )
    `
    )
    .eq("id", courseId)
    .single();

  if (courseError || !courseData) {
    error = "Nie znaleziono kursu";
  } else {
    course = courseData;
    allLessons = courseData.lessons.sort((a: any, b: any) => a.order_index - b.order_index);

    // Find current lesson
    lesson = allLessons.find((l: any) => l.id === lessonId);

    if (!lesson) {
      error = "Nie znaleziono lekcji";
    } else {
      // Check access
      const isFree = !course.price || course.price === 0;
      const { data: enrollment } = await supabase
        .from("course_enrollments")
        .select("id")
        .eq("course_id", courseId)
        .eq("user_id", user.id)
        .single();

      hasAccess = isFree || !!enrollment || course.instructor_id === user.id || user.role === "admin";

      if (hasAccess) {
        // Fetch lesson progress for all lessons
        const { data: progressData } = await supabase
          .from("lesson_progress")
          .select("lesson_id, completed, completed_at")
          .eq("course_id", courseId)
          .eq("user_id", user.id);

        lessonProgress = progressData || [];

        // Fetch quizzes for current lesson
        const { data: quizzesData } = await supabase
          .from("quizzes")
          .select("*")
          .eq("lesson_id", lessonId)
          .order("created_at", { ascending: false });

        if (quizzesData) {
          // For each quiz, get user's attempts info
          const quizzesWithAttempts = await Promise.all(
            quizzesData.map(async (quiz) => {
              const { data: attempts } = await supabase
                .from("quiz_attempts")
                .select("id, score, passed, completed_at")
                .eq("quiz_id", quiz.id)
                .eq("user_id", user.id)
                .order("completed_at", { ascending: false });

              const attemptsCount = attempts?.length || 0;
              const bestScore = attempts && attempts.length > 0 ? Math.max(...attempts.map((a) => a.score)) : 0;
              const hasPassed = attempts?.some((a) => a.passed) || false;
              const canAttempt = quiz.max_attempts === null || attemptsCount < quiz.max_attempts;

              return {
                ...quiz,
                user_attempts_count: attemptsCount,
                user_best_score: bestScore,
                user_has_passed: hasPassed,
                can_attempt: canAttempt,
              };
            })
          );

          quizzes = quizzesWithAttempts;
        }
      }
    }
  }
} catch (err) {
  console.error("Error fetching lesson:", err);
  error = "Wystąpił błąd podczas pobierania lekcji";
}

// Calculate progress and lesson accessibility
const progressMap = new Map(lessonProgress.map((p) => [p.lesson_id, p.completed]));
const lessonsWithProgress = allLessons.map((l, index) => {
  const completed = progressMap.get(l.id) || false;
  
  // Check if lesson is accessible based on sequential mode
  let isAccessible = true;
  if (course?.lesson_access_mode === "sequential" && index > 0) {
    // Check if all previous lessons are completed
    const previousLessons = allLessons.slice(0, index);
    isAccessible = previousLessons.every((pl) => progressMap.get(pl.id) === true);
  }

  return {
    ...l,
    completed,
    is_accessible: isAccessible,
  };
});

// Calculate overall progress
const completedCount = lessonsWithProgress.filter((l) => l.completed).length;
const totalCount = lessonsWithProgress.length;
const progressPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

const progress = {
  completed: completedCount,
  total: totalCount,
  percentage: progressPercentage,
};

// Find previous and next lessons
const currentIndex = lessonsWithProgress.findIndex((l) => l.id === lessonId);
const previousLesson = currentIndex > 0 ? lessonsWithProgress[currentIndex - 1] : null;
const nextLesson = currentIndex < lessonsWithProgress.length - 1 ? lessonsWithProgress[currentIndex + 1] : null;

// Check if current lesson is completed
const isCompleted = progressMap.get(lessonId) || false;

// Add completed and is_accessible to current lesson
if (lesson) {
  lesson.completed = isCompleted;
  lesson.is_accessible = lessonsWithProgress.find((l) => l.id === lessonId)?.is_accessible || false;
}
---

<Layout title={lesson ? `${lesson.title} - ${course.title}` : "Lekcja"}>
  {
    error || !lesson || !hasAccess ? (
      <div class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 flex items-center justify-center px-4">
        <div class="max-w-md w-full bg-slate-800/50 border border-white/10 backdrop-blur-sm rounded-lg p-8 text-center">
          <p class="text-red-400 text-lg mb-4">{error || "Brak dostępu do tej lekcji"}</p>
          <button
            onclick="window.history.back()"
            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
          >
            Wróć
          </button>
        </div>
      </div>
    ) : (
      <div class="flex min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950">
        {/* Sidebar */}
        <LessonSidebar
          courseId={courseId}
          courseTitle={course.title}
          currentLessonId={lessonId}
          lessons={lessonsWithProgress}
          progress={progress}
          lessonAccessMode={course.lesson_access_mode || "all_access"}
          client:load
        />

        {/* Main Content */}
        <LessonContent
          lesson={lesson}
          courseId={courseId}
          courseTitle={course.title}
          quizzes={quizzes}
          isCompleted={isCompleted}
          previousLesson={previousLesson}
          nextLesson={nextLesson}
          client:load
        />
      </div>
    )
  }
</Layout>
